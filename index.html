<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="title">CHAT - å³æ™‚çš„èŠå¤©ç³»çµ±</title>
  <link rel="shortcut icon" href="/icon/favicon.ico" />
  <!--BS CSS only -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
  <style>
    body {
      margin: 8px;
      padding-bottom: 3rem;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    nav {
      position: sticky;
      width: 100%;
      top: 0;
    }

    #bottom {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
    }

    #bottom-bar {
      background: rgba(0, 0, 0, 0.15);
      padding: 0.25rem;

      display: flex;
      height: 3rem;
      box-sizing: border-box;
      backdrop-filter: blur(10px);
    }

    #input {
      border: none;
      padding: 0 1rem;
      flex-grow: 1;
      border-radius: 2rem;
      margin: 0.25rem;
    }

    #input:focus {
      outline: none;
    }

    #messages,
    ul {
      list-style-type: none;
      margin: 0;
      padding: 0;
    }

    #messages>li {
      padding: 0.5rem 1rem;
      border-bottom: 1px #333 solid;
    }


    .statue-bar {
      position: sticky;
      top: 0px;
      background-color: #fff;


    }

    .flex {
      display: flex;
    }

    .warn {
      background-color: #f4a3ab !important;
    }

    .success {
      background-color: #98f9b1 !important;
    }

    .info {
      background-color: #94e3ff !important;
    }


    table,
    td {
      border: 1px solid #333;
    }

    thead,
    tfoot {
      background-color: #333;
      color: #fff;
    }

    .btn-file {
      position: relative;
      overflow: hidden;
    }

    .btn-file input[type=file] {
      position: absolute;
      top: 0;
      right: 0;
      min-width: 100%;
      min-height: 100%;
      font-size: 100px;
      text-align: right;
      filter: alpha(opacity=0);
      opacity: 0;
      outline: none;
      background: white;
      cursor: inherit;
      display: block;
    }


    .text {
      border: 1px #333 solid;
      border-radius: 5px;
      max-height: 500px;
    }

    .badge>h6 {
      margin: 0;
    }

    .radio input[type="radio"] {
    display: none;
  }

  .checkbox input[type="checkbox"] {
    display: none;
  }

  .radio input:checked+.button {
    background: #3296d4;
    color: #fff;
    cursor: default;
  }

  .checkbox input:checked+.button {
    background: #3296d4;
    color: #fff;
    cursor: pointer;

  }

  .radio .button,
  .checkbox .button {
    display: inline-block;


    margin: 0 0.5vw 0.5vw 0;
    padding: 0.25vw 0.5vw;
    background: #f7f7f7;
    color: #333;
    cursor: pointer;
    border: 1px solid #8b8b8b;
    transition: background-color 0.3s, color 0.3s;
  }

  .radio .button:hover,
  .checkbox .button:hover {
    background-color: #bbb;
    color: #fff;
  }

  .radio .round,
  .checkbox .round {
    border-radius: 5px;
  }
  
  </style>
</head>

<body >
  <div id="logined-ui" style="display: none;">
    <div class="collapse" id="navbarToggleExternalContent">
      <div class="bg-dark p-4">
        <div>
          <div class="flex">
            <div>
              <div class="position-relative">
                <svg xmlns="http://www.w3.org/2000/svg" style="width: 3em; height:3em; color:#fff" fill="currentColor"
                  class="bi bi-person-circle" viewBox="0 0 16 16">
                  <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z" />
                  <path fill-rule="evenodd"
                    d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z" />
                </svg>
                <span id="statue-circle"
                  class="position-absolute top-0 start-100 translate-middle p-2 bg-success border border-light rounded-circle">

                </span>
              </div>
            </div>


            <ul style="color: #fff; margin-left: 1em;">
              <li hidden>
                <form id="rename_nickname_farm" action="">
                  æš±ç¨±:<input id="NMinput" placeholder="è¼¸å…¥æš±ç¨±..." value="User">
                  <button id="changeNM" class="btn btn-outline-light">é€å‡ºæ›´æ”¹</button>
                </form>
              </li>
              <li>
                <h3 class="nickname"></h3>
               <div class="flex"> <h6>@</h6><h6 id="Sid" style="margin:0">---</h6></div>
              </li>
              <li>
                <form id="reset_statue_farm" action="">
                  ç‹€æ…‹:
                  <select id="statue_select" style="
                background-color: rgba(var(--bs-dark-rgb),var(--bs-bg-opacity)) !important;
                color: inherit;" onblur="
                if(this.value.includes('statue_Green')){$('#statue-circle').attr('class','position-absolute top-0 start-100 translate-middle p-2 bg-success border border-light rounded-circle')}
                else if(this.value.includes('statue_Yellow')){$('#statue-circle').attr('class','position-absolute top-0 start-100 translate-middle p-2 bg-warning border border-light rounded-circle')}
                else if(this.value.includes('statue_White')){$('#statue-circle').attr('class','position-absolute top-0 start-100 translate-middle p-2 bg-light border border-light rounded-circle')}
                else if(this.value.includes('statue_Red')){$('#statue-circle').attr('class','position-absolute top-0 start-100 translate-middle p-2 bg-danger border border-light rounded-circle')}
                else if(this.value.includes('statue_Blue')){$('#statue-circle').attr('class','position-absolute top-0 start-100 translate-middle p-2 bg-primary border border-light rounded-circle')}
                ">
                    <option value="statue_Green:online">ç·šä¸ŠğŸŸ¢</option>
                    <option value="statue_Yellow:leave">é›¢é–‹ğŸŸ¡</option>
                    <option value="statue_Red:busy">å¿™ç¢ŒğŸ”´</option>
                    <option value="statue_White:disconnect">é›¢ç·šâšª</option>
                  </select>


                </form>

              </li>



              <li>é€£ç·šç‹€æ…‹: &nbsp; <span id="connectStatue">æœªé€£ç·š</span>
              </li>
              <li class="flex"><span>ç·šä¸Šäººæ•¸:&nbsp;</span><span class="onlinePeople">æœªçŸ¥</span></li>
            </ul>


          </div>

          <div class="flex">
            <button class="btn btn-outline-light" onclick="socket.emit('GetUsers',{'room':MyRooom})" data-bs-toggle="modal"
              data-bs-target="#Modal-1">äººå“¡æ¸…å–®</button>
            <a href="https://jerry20200815.herokuapp.com?create=true" target="_blank"
              class="btn btn-outline-light">å»ºç«‹ç¾¤çµ„</a>
            <a href="https://jerry20200815.herokuapp.com?join=true" target="_blank"
              class="btn btn-outline-light">åŠ å…¥ç¾¤çµ„</a>
          </div>

        </div>
      </div>



    </div>

    <nav class="navbar navbar-dark bg-dark flex" style="position: sticky;
    width: 100%;
    top: 0;">

      <div class="container-fluid">
        <h1 style="color:#fff">CHAT</h1>
        <button class="navbar-toggler" type="button" onclick="window.scrollTo(0,0)" data-bs-toggle="collapse"
          data-bs-target="#navbarToggleExternalContent" aria-controls="navbarToggleExternalContent"
          aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

      </div>
    </nav>

    <ul id="messages">
      <li>æ­£åœ¨é€£æ¥è‡³ä¼ºæœå™¨...</li>

    </ul>

    <div id="bottom">
      <label id="isTypeing" style="backdrop-filter: blur(10px);background: rgba(0, 0, 0, 0.15);"></label>

      <div id="bottom-bar">

        <button class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#Modal-2"
          style="flex-shrink:1; min-width:90px"
          onclick='socket.emit("typeing",{"id":socket.id,"room":MyRooom});$("#statue-circle").attr("class","position-absolute top-0 start-100 translate-middle p-2 bg-primary border border-light rounded-circle")'>å‚³é€åœ–ç‰‡</button>
        &nbsp;
        <button class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#Modal-3"
          style="flex-shrink:1; min-width:90px"
          onclick='socket.emit("typeing",{"id":socket.id,"room":MyRooom});$("#statue-circle").attr("class","position-absolute top-0 start-100 translate-middle p-2 bg-primary border border-light rounded-circle")''>å‚³é€æ–‡å­—</button>
      <form id="form" action="" class="flex" style="width:100%">





        <input id="input" autocomplete="off" placeholder="è¼¸å…¥æ–°è¨Šæ¯" 
        oninput="
          socket.emit(' typeing', {'id':socket.id,'room':MyRooom}); $('#statue-circle').attr('class','position-absolute top-0 start-100 translate-middle p-2 bg-primary border border-light rounded-circle')"
        onblur="
          socket.emit('typeing-end',{'id':socket.id,'room':MyRooom});
          $('#statue-circle').attr('class','position-absolute top-0 start-100 translate-middle p-2 bg-success border border-light rounded-circle')">


          <button class="btn btn-outline-dark">é€å‡ºè¨Šæ¯</button>
          </form>
      </div>
    </div>
  </div>

  <div id="login-ui-1">
    <h1>æ­¡è¿ä¾†åˆ°CHAT</h1>
    <h5>æˆ‘å€‘è©²å¦‚ä½•ç¨±å‘¼æ‚¨?</h5>
    <span>
      <p></p>
      <div class="form-floating mb-3">
        <input type="text" class="form-control" id="nickname-input-set" placeholder="è«‹è¼¸å…¥æš±ç¨±">
        <label for="floatingInput">è«‹è¼¸å…¥æš±ç¨±</label>
      </div>
    </span><br>
    <span class="badge bg-primary">
      <h6>é€™æ˜¯æ‚¨åœ¨CHATé¡¯ç¤ºçš„åç¨±ï¼Œä¹Ÿæ˜¯ä»–äººèªå¾—æ‚¨çš„æ–¹å¼</h6>
    </span>
    <p></p><span class="badge bg-danger">
      <h6>è«‹æ³¨æ„:æš±ç¨±ç„¡æ³•ä¿®æ”¹</h6>
    </span>
    <p></p><span class="badge bg-danger" id="set-alert" style="display: none;">
      <h6>**æœ€å¾Œä¸€å€‹å­—ç¬¦ä¸å¯ä»¥æ˜¯ç©ºç™½**</h6>
    </span>
    <p></p><span class="badge bg-danger" id="set-alert-2" style="display: none;">
      <h6>**è«‹å¡«å¯«æš±ç¨±**</h6>
    </span>
    <p></p><span class="badge bg-success" id="set-info" style="display: none;">
      <h6>è®Šæ›´å·²ç¶“å„²å­˜ï¼Œæ­£åœ¨å‘ä¼ºæœå™¨ç¢ºèªä½ çš„IDï¼Œè«‹å…ˆ<B>ä¸è¦</B>åˆ·æ–°ç¶²é </h6>
    </span>
    <p></p><span class="badge bg-success" id="set-info-2" style="display: none;">
      <h6></h6>
    </span>
    <p></p>
    <button class="btn btn-secondary" onclick="
  if($('#nickname-input-set').val().slice(-1) == ' '){
    $('#set-alert').show()
  }
  else if($('#nickname-input-set').val() == ''){
    $('#set-alert-2').show()
  }
  else{
    localStorage.setItem('CHAT', true)
    localStorage.setItem('myNickname',$('#nickname-input-set').val())
    socket.connect()
    socket.emit('GetID', { 'from': socket.id })
    $('#set-info').show()
    $(this).attr('disabled',true)
  }">ç¢ºå®š</button>
  </div>


  <div id="login-ui-2">
    <h1>Hi,<span class="nickname"></span></h1>
    <h5>è«‹é¸æ“‡åŠ å…¥æˆ¿é–“ï¼Œæˆ–å»ºç«‹æ–°æˆ¿é–“</h5>

    <div class='flex'>
      <div class='radio'><label
        onclick="
        if(document.getElementById('dl-file-1').checked){
          $('#createRoom').hide();
          $('#joinRoom').show();
          
        }"><input type='radio' id='dl-file-1' name='dl-radio' 
        ><span class='round button'>
            <center>åŠ å…¥æˆ¿é–“</center>
          </span></label></div>

      <div class='radio'><label
        onclick="
        if(document.getElementById('dl-file-2').checked){
          $('#createRoom').show();
          $('#joinRoom').hide();
        }">
        <input type='radio' id='dl-file-2'name='dl-radio'><span class='round button'>
            <center>å»ºç«‹æˆ¿é–“</center>
          </span></label>
            </div>

          <p></p><br>
        
    </div>
    <div id="createRoom">
      <span>è¼¸å…¥æˆ¿é–“åç¨±<input type="text" id="create-room-name"></span>
      <p><span>è¼¸å…¥æˆ¿é–“å¯†ç¢¼(è‹¥ä¸æƒ³è¨­å®šè«‹å‹¿è¼¸å…¥)<input type="password" id="create-room-pws"></span></p>
      <p><span>ç¢ºèªæˆ¿é–“å¯†ç¢¼<input type="password" id="create-room-pws-2"></span></p>
      <p><div class="alert alert-danger">æˆ¿é–“å¯†ç¢¼è«‹å‹™å¿…ç‰¢è¨˜!</div></p>
      
      <p><button class="btn btn-primary" onclick="
        if($('#create-room-name').val() == ''){
          $('#create-statue').append('è«‹è¼¸å…¥æˆ¿é–“åç¨±<br>')
        }else if($('#create-room-pws').val() !== $('#create-room-pws-2').val()){
          $('#create-statue').append('å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸åŒï¼Œè«‹é‡æ–°è¼¸å…¥<br>')

        }else if($('#create-room-pws').val() == $('#create-room-pws-2').val()){
          $('#create-statue').append('æˆ¿é–“åç¨±: '+$('#create-room-name').val()+'<br>')

          $('#create-statue').append('æ­£åœ¨æ–°å¢æˆ¿é–“ï¼Œè«‹å…ˆä¸è¦åˆ·æ–°é é¢<br>')
          socket.emit('create',{'name':$('#create-room-name').val(),'pws':$('#create-room-pws').val()})
        }
        
        
        
        
        ">ç¢ºå®š</button></p>
        <p><span id="create-statue"></span></p>
    </div>
    <div id="joinRoom">
      <span>è¼¸å…¥æˆ¿é–“ID<input type="text" id="join-room-name" value="@room-1"></span>
      <p><span>è¼¸å…¥æˆ¿é–“å¯†ç¢¼<input type="password" id="join-room-pws"></span></p>
      <p><div id="join-alert" class="alert alert-info"><span id="join-room-name">ä¸»èŠå¤©å®¤(@room-1)</span><span id="join-info">æ²’æœ‰å¯†ç¢¼</span></div></p>
      <p><div id="join-alert-2" class="alert alert-danger">è«‹å‹¿é‡è¤‡åŠ å…¥åŒä¸€æˆ¿é–“!</div></p>
      <p><button class="btn btn-primary" onclick="
        
        socket.emit('join',{'id':localStorage.getItem('myID'),'nickname':localStorage.getItem('myNickname'),'room':$('#join-room-name').val(),'pws':$('#join-room-pws').val()})
        $('#join-statue').append('æ­£åœ¨é€£ç·šåˆ°èŠå¤©å®¤:'+$('#join-room-name').val()+'<br>')
        ">ç¢ºå®š</button></p>
      <p><span id="join-statue"></span></p>
    </div>
  </div>








  <!-- Modal + contextmenu-->
  <div class="modal fade" id="Modal-1" tabindex="-1" aria-labelledby="Modal-1Label" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="Modal-1Label">ç·šä¸Šäººå“¡</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">


          <p>ç·šä¸Šäººæ•¸:<span class="onlinePeople"></span></p>

          <table>
            <thead>
              <tr>
                <td>æš±ç¨±</td>
                <td>ID</td>
                <td>ç‹€æ…‹</td>

              </tr>
            <tbody id="PeopleOnLine">
              <td colspan="3">æ­£åœ¨å–å¾—è³‡æ–™...</td>
            </tbody>
          </table>
          <br><p></p>
          <p><button class="btn btn-outline-primary" onclick="socket.emit('GetUsers',{'room':MyRooom})">é‡æ–°æ•´ç†</button></p>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>

        </div>
      </div>
    </div>
  </div>





  <div class="modal fade" id="Modal-2" tabindex="-1" aria-labelledby="Modal-2Label" aria-hidden="true"
    data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="Modal-2Label">å‚³é€åœ–ç‰‡</h5>
          <button type="button" onclick='socket.emit("typeing-end",{"id":socket.id,"room":MyRooom})' class="btn-close" data-bs-dismiss="modal"
            aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <span class=" btn-file btn btn-secondary">


            é¸æ“‡æª”æ¡ˆ <input type="file" id="upload-input" accept="image/jpeg, image/png">

          </span>

          <img>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
              onclick='socket.emit("typeing-end",{"id":socket.id,"room":MyRooom})'>é—œé–‰</button>
            <button type="button" class="btn btn-warning" data-bs-dismiss="modal" onclick='
                  if(isfile){
                  let filename =  document.getElementById("upload-input").files[0].name                                                                        
                  socket.emit("send img",{"src":img.attr("src"),"filename":filename,"to":MyRooom})
                  console.log(img.attr("src"))
                  socket.emit("typeing-end",{"id":socket.id,"room":MyRooom})
                  $("#statue-circle").attr("class","position-absolute top-0 start-100 translate-middle p-2 bg-success border border-light rounded-circle")
                  }
                  '>é€å‡º</button>
          </div>
        </div>
      </div>
    </div>
  </div>



  <div class="modal fade" id="Modal-3" tabindex="-1" aria-labelledby="Modal-3Label" aria-hidden="true"
    data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="Modal-3Label">å‚³é€æ–‡å­—æª”</h5>
          <button type="button" onclick='socket.emit("typeing-end",{"id":socket.id,"room":MyRooom})' class="btn-close" data-bs-dismiss="modal"
            aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <span class=" btn-file btn btn-secondary">


            é¸æ“‡æª”æ¡ˆ <input type="file" id="upload-input-txt" accept="text/plain , .txt">

          </span>

          <pre class="text" id="txt-preview"></pre>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
              onclick='socket.emit("typeing-end",{"id":socket.id,"room":MyRooom})'>é—œé–‰</button>
            <button type="button" class="btn btn-warning" data-bs-dismiss="modal" onclick='
              
                   let filename =  document.getElementById("upload-input-txt").files[0].name  
                  socket.emit("send txt",{"src":txtfile,"filename":filename,"to":MyRooom})
                  
                  socket.emit("typeing-end",{"id":socket.id,"room":MyRooom})
                  $("#statue-circle").attr("class","position-absolute top-0 start-100 translate-middle p-2 bg-success border border-light rounded-circle")
                
                  '>é€å‡º</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="contextmenu" style="display: none;">
    <div id="content-tool"></div>
    <ul id="contextmenu-ul">

    </ul>


  </div>




  <script src="/socket.io/socket.io.js"></script>
  <!-- <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>-->
  <script src="/js/jquery.js"></script>

  <!--BS5 JavaScript Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ"
    crossorigin="anonymous"></script>
  <script>
    var socket = io();

    var messages = document.getElementById('messages');
    var form = document.getElementById('form');
    var input = document.getElementById('input');
    var rename_nickname_farm = document.getElementById('rename_nickname_farm');

    var my_nickname = ""
    var last_nickname = ""
    var isConnected = false

    var MyRooom
    //ç§»å‹•è£ç½®æª¢æ¸¬
    window.mobileAndTabletCheck = function () {
      let check = false;
      (function (a) { if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true; })(navigator.userAgent || navigator.vendor || window.opera);
      return check;
    };
    (function ($) {
      $.UrlParam = function (name) {
        //å®£å‘Šæ­£è¦è¡¨é”å¼
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        /*
         * window.location.search ç²å–URL ?ä¹‹å¾Œçš„åƒæ•¸(åŒ…å«å•è™Ÿ)
         * substr(1) ç²å–ç¬¬ä¸€å€‹å­—ä»¥å¾Œçš„å­—ä¸²(å°±æ˜¯å»é™¤æ‰?è™Ÿ)
         * match(reg) ç”¨æ­£è¦è¡¨é”å¼æª¢æŸ¥æ˜¯å¦ç¬¦åˆè¦æŸ¥è©¢çš„åƒæ•¸
        */
        var r = window.location.search.substr(1).match(reg);
        //å¦‚æœå–å‡ºçš„åƒæ•¸å­˜åœ¨å‰‡å–å‡ºåƒæ•¸çš„å€¼å¦å‰‡å›ç©¿null
        if (r != null) return (r[2]); return null;
      }
    })(jQuery);



    //local
    if (localStorage.getItem("CHAT") == null) {
      $("#login-ui-1").show()
      $("#login-ui-2").hide()

    } else {
      $("#login-ui-2").show();
      $("#login-ui-1").hide()
      $("#createRoom,#joinRoom").hide();
      $(".nickname").html(localStorage.getItem("myNickname"))


    

    }

    socket.on("PostID", function (id) {
      localStorage.setItem("myID", id)
      $("#Sid").html(id)
      $("#set-info-2").html("<h6>è«‹è¨˜ä¸‹ä½ çš„ID: " + id + "ï¼Œç¾åœ¨ä½ å¯ä»¥åˆ·æ–°ç¶²é ä¾†åŠ å…¥èŠå¤©äº†</h6>").show()
      socket.disconnect()

    })
    socket.on("password incorrect", function (room) {
      $('#join-statue').append("è¼¸å…¥çš„èŠå¤©å®¤IDæˆ–å¯†ç¢¼éŒ¯èª¤<br>")

    })
    socket.on("room not found", function (room) {
      $('#join-statue').append("æ‰¾ä¸åˆ°èŠå¤©å®¤: "+room+"<br>")

    })

    socket.on("welcome", function (room) {
      $('#join-statue').append("æ­¡è¿é€²å…¥èŠå¤©å®¤: "+room+"<br>");
      MyRooom = room
      socket.emit("statue",{"statue":$("#statue_select").val()})
      socket.emit('GetUsers',{'room':MyRooom})
      $("#login-ui-2").hide();
      $("#login-ui-1").hide();
      $("#logined-ui").show();
      $("#messages").html("<li>èŠå¤©å®¤:"+MyRooom+"</li>")
      $("title").text("CHAT - "+MyRooom)
      $("#Sid").html(localStorage.getItem("myID"))
      
    })

    socket.on("created",msg=>{
      $('#create-statue').append('æˆ¿é–“ '+msg.name+"å·²ç¶“å»ºç«‹å®Œæˆ<br>IDæ˜¯: "+msg.id+'<br>åˆ‡æ›åˆ° åŠ å…¥ ä»¥åŠ å…¥æ­¤æˆ¿é–“')
      $("#join-room-name").val(msg.id)
      $("#join-room-pws").val(msg.pws)
    })

    //img input
    var img = $('img');
    var isfile = false
    img.css('display', 'none');



    function readfichier(e) {
      if (window.FileReader) {
        var file = e.target.files[0];
        var reader = new FileReader();
        if (file && file.type.match('image.*')) {
          reader.readAsDataURL(file);
          isfile = true;
        } else {
          img.css('display', 'none');
          img.attr('src', '');
        }
        reader.onloadend = function (e) {
          img.attr('src', reader.result);
          img.css('display', 'block');

          img.css("max-width", (img.parent().width() - 15))
        }
      }
    }

    document.getElementById('upload-input').addEventListener('change', readfichier, false);



    //txt input

    var istxtfile = false
    var preview_txt = $("#txt-preview")
    var txtfile = ""


    function treadfichier(e) {
      if (window.FileReader) {
        var tfile = e.target.files[0];
        var treader = new FileReader();
        if (tfile) {
          treader.readAsText(tfile);
          istxtfile = true;
        } else {

        }
        treader.onloadend = function (e) {
          preview_txt.html(treader.result)
          txtfile = treader.result



        }
      }
    }

    document.getElementById('upload-input-txt').addEventListener('change', treadfichier, false);




    form.addEventListener('submit', function (e) {
      e.preventDefault();
      if (input.value) {
        socket.emit('chat message room', {'msg':(input.value).replace(/\n/g, '<!b>').replace(/\t/g, '<!t>').replace(/ /g, '<!s>'),'room':MyRooom});
        if (!isConnected) {
          var item = document.createElement('li');
          item.textContent = "è¨Šæ¯ç™¼é€å¤±æ•—! ç„¡æ³•ç™¼é€çš„è¨Šæ¯: " + input.value;
          messages.appendChild(item);
          item.setAttribute("class", "warn")
          window.scrollTo(0, document.body.scrollHeight);
        }
        input.value = '';
        socket.emit("typeing-end", {'id':socket.id,'room':MyRooom})

      }
    });

    rename_nickname_farm.addEventListener('submit', function (e) {
      e.preventDefault();
      if (document.getElementById("NMinput").value && document.getElementById("NMinput").value !== my_nickname) {
        socket.emit('rename_nickname', document.getElementById("NMinput").value);
        last_nickname = my_nickname
        my_nickname = document.getElementById("NMinput").value

        if (!isConnected) {
          var item = document.createElement('li');
          item.textContent = " : ( èˆ‡ä¼ºæœå™¨é€£æ¥å¤±æ•—! ";
          messages.appendChild(item);
          item.setAttribute("class", "warn")
          window.scrollTo(0, document.body.scrollHeight);
        }
      }
    });

    $("#statue_select").on("blur",function(){
      socket.emit("statue",{"statue":$("#statue_select").val(),"room":MyRooom})
    })

    socket.on("UserList", function (msg) {
      if(msg.to == MyRooom){
        $("#PeopleOnLine").html("")
       let count = 0
       console.log(msg)

      for (let r = 0; r < (msg.userID).length; r++) {
        console.log(msg.statue[r])
        if(msg.nickname !== undefined && msg.nickname !== null &&msg.userID !== null){
          $("#PeopleOnLine").html($("#PeopleOnLine").html() + "<tr>" + "<td>" + msg.nickname[r] + "</td>" + "<td>" + msg.userID[r] + "</td>" +"<td>"+msg.statue[r]+"</td>"+ "</tr>")
          count++  
        }else{
        
        }

      }  
      $(".onlinePeople").html(count)
      
      }

    })

    socket.on('chat message room', function (msg) {

      if(msg.room == MyRooom){

      
      $("#messages").append("<li>" + (msg.msg).replace(/<!b>/g, '<br>').replace(/<!t>/g, '&nbsp;&nbsp;&nbsp;&nbsp;').replace(/<!s>/g, '&nbsp;') + "</li>")
      isConnected = true

      window.scrollTo(0, document.body.scrollHeight);
      }
    });

    socket.on('send img', function (msg) {
      if(msg.to == MyRooom){
      $("#messages").append("<li>" + msg.text + "<br>æª”æ¡ˆåç¨±:" + msg.filename + "<p></p><img src='" + msg.src + "' id='" + msg.id + "' alt='" + msg.alt + "'></li>")
      window.scrollTo(0, document.body.scrollHeight);
      isConnected = true
      $("#" + msg.id).css("max-width", ($("#" + msg.id).parent().width() - 30))
      }
    });

    socket.on('send txt', function (msg) {
      if(msg.to == MyRooom){
      console.log(("https://jerry20201230.github.io/%E6%96%87%E5%AD%97%E7%B7%A8%E8%BC%AF%E5%99%A8/?file-name=" + encodeURIComponent(msg.filename) + "&data=" + encodeURIComponent(msg.src.replace(/\n/g, '<!b>').replace(/\t/g, '<!t>').replace(/ /g, '<!s>'))).length)
      if (("https://jerry20201230.github.io/%E6%96%87%E5%AD%97%E7%B7%A8%E8%BC%AF%E5%99%A8/?file-name=" + encodeURIComponent(msg.filename) + "&data=" + encodeURIComponent(msg.src.replace(/\n/g, '<!b>').replace(/\t/g, '<!t>').replace(/ /g, '<!s>'))).length > 10000) {
        $("#messages").append("<li>" + msg.text + "<br>æª”æ¡ˆåç¨±:" + msg.filename + "<p></p><pre class='text'" + "' id='" + msg.id + "'>" + msg.src + "</pre></li>")
      } else {
        $("#messages").append("<li>" + msg.text + "<br>æª”æ¡ˆåç¨±:" + msg.filename + "<p></p><pre class='text'" + "' id='" + msg.id + "'>" + msg.src + "</pre><br>åœ¨<a target='_blank' href='https://jerry20201230.github.io/%E6%96%87%E5%AD%97%E7%B7%A8%E8%BC%AF%E5%99%A8/?file-name=" + encodeURIComponent(msg.filename) + "&data=" + encodeURIComponent(msg.src.replace(/\n/g, '<!b>').replace(/\t/g, '<!t>').replace(/ /g, '<!s>')) + "'>æ–‡å­—ç·¨è¼¯å™¨</a>ä¸­ç·¨è¼¯</li>")

      }
      isConnected = true
      $("#" + msg.id).css("max-width", ($("#" + msg.id).parent().width() - 30))
      window.scrollTo(0, document.body.scrollHeight);
    }
    });


    socket.on('sys-info chat message', function (msg) {
   console.log(msg) ;
    if(msg.to == MyRooom ||msg.to == localStorage.getItem("MyID") || msg.to == "you" ){
     
        var item = document.createElement('li');
      item.textContent = msg.msg;
      messages.appendChild(item);
      item.setAttribute("class", "info")
      window.scrollTo(0, document.body.scrollHeight);
      isConnected = true
      if (msg.msg.includes("è«‹å‹¿ä½¿ç”¨èˆ‡åˆ¥äººç›¸åŒçš„æš±ç¨±")) {
        my_nickname = last_nickname
      }
    }


    });

    socket.on('sys-warn chat message', function (msg) {
      var item = document.createElement('li');
      item.textContent = msg;
      messages.appendChild(item);
      item.setAttribute("class", "warn")
      window.scrollTo(0, document.body.scrollHeight);
      isConnected = true


    });
    socket.on('nickname', function (msg) {
      document.getElementById("NMinput").setAttribute("value", msg)
      var item = document.createElement('li');
      item.textContent = "ç³»çµ±è‡ªå‹•ç”Ÿæˆæš±ç¨±: " + msg;
      messages.appendChild(item);
      item.setAttribute("class", "info")
      window.scrollTo(0, document.body.scrollHeight);
      isConnected = true
      my_nickname = msg


    });
    socket.on("BAN", function (msg) {

      var item = document.createElement('li');
      item.textContent = "ä½ çš„é€£æ¥å·²è¢«ä¼ºæœå™¨ä¸­æ–· [åŸå› ] å¤§é‡ç™¼é€ç›¸åŒè¨Šæ¯/æ´—ç‰ˆ"
      messages.appendChild(item);
      item.setAttribute("class", "warn")
      window.scrollTo(0, document.body.scrollHeight);
      socket.disconnect()
    })

    socket.on('people online', function (msg) 
    {
     if(msg.for == MyRooom){
      $(".onlinePeople").html(msg)
      isConnected = true
     }
    });
    socket.on('typeing', function (msg) {
      if (msg == " æ­£åœ¨è¼¸å…¥...") {
        $("#isTypeing").html("")
      } else {
        $("#isTypeing").html(msg)
      }

    });
    socket.on('typeing-end', function (msg) {
      if (msg == " æ­£åœ¨è¼¸å…¥...") {
        $("#isTypeing").html("")
      } else {
        $("#isTypeing").html(msg)
      }

    });


    socket.on("connect", () => {
      isConnected = true
      console.log(socket.id);
      console.log("connected")
      var item = document.createElement('li');
      item.textContent = "è£ç½®å·²é€£æ¥åˆ°ä¼ºæœå™¨,idæ˜¯:" + socket.id;
      messages.appendChild(item);
      item.setAttribute("class", "success")
      window.scrollTo(0, document.body.scrollHeight);

      document.getElementById("connectStatue").innerHTML = "å·²é€£ç·š"
      document.getElementById("connectStatue").style.color = "#39ef2f"
      document.getElementById("isTypeing").innerHTML = " "


    });

    socket.on("disconnect", () => {
      isConnected = false
      console.log("disconnected")
      var item = document.createElement('li');
      item.textContent = "è£ç½®æœªé€£æ¥åˆ°ä¼ºæœå™¨,æ­£åœ¨å˜—è©¦é€£æ¥...";
      messages.appendChild(item);
      item.setAttribute("class", "warn")
      window.scrollTo(0, document.body.scrollHeight);
      document.getElementById("connectStatue").innerHTML = "æœªé€£ç·š / å·²æ–·ç·š"
      document.getElementById("connectStatue").style.color = "#ce3434"
      document.getElementById("isTypeing").innerHTML = "è£ç½®æœªé€£æ¥åˆ°ä¼ºæœå™¨ï¼Œç„¡æ³•å‚³é€è¨Šæ¯"
    });




    /*  
    <div id="contextmenu" style="display: none;">
      <div id="content-tool"></div>
      <ul id="contextmenu-ul">

      </ul>
    </div>*/
    window.oncontextmenu = function (e) {
      contextmenu.x = e.clientX;
      contextmenu.y = e.clientY;
      e.preventDefault()
    }
    var contextmenu = {
      menu: $("#contxtmenu"),
      x: 0,
      y: 0,
      set: function (count, text, callback) {

        for (let i = 0; i < count; i++) {

          $("#contextmenu-ul").append("<li onclick='" + callback[i] + "'>" + text[i] + "</li>")
        }
      },
      show: function (callback) {

        //é¸å–®å‡ºç¾å¾Œçš„ä½ç½®
        contextmenu.menu.css("display", "block")
        contextmenu.menu.css("left", contextmenu.x + 'px')
        contextmenu.menu.css("top", contextmenu.y + 'px')

        $("#contxtmenu").show()
      }
    }
  </script>
</body>

</html>